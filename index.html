<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Shadow of the Hell ‚Äì Nivel 1</title>
<style>
  html, body { margin:0; width:100%; height:100%; overflow:hidden; background:#000; }
  #renderCanvas { width:100%; height:100%; display:block; }
  #joystick-container { position:absolute; bottom:30px; left:30px; width:150px; height:150px; z-index:10; }
  #hud { position:absolute; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:20; }
  #healthBarContainer { width:250px; height:25px; background:#444; border:1px solid #fff; margin:10px; }
  #healthBar { height:100%; width:100%; background:#0f0; transition:width 0.2s; }
  #keyIndicator { position:absolute; top:45px; left:270px; width:30px; height:30px;
    background:url('https://i.ibb.co/HpKK2xwJ/1000012289-removebg-preview.png') no-repeat center/contain;
    opacity:0; }
  .action-btn { position:absolute; bottom:30px; width:80px; height:80px; margin:0 20px;
    border-radius:50%; background:rgba(255,255,255,0.2); pointer-events:auto;
    font-size:36px; line-height:80px; text-align:center; }
  #attack-btn { right:120px; border:3px solid #f50; }
  #magic-btn { right:30px; border:3px solid #06f; }
  .msg { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
    padding:8px 16px; color:#fff; font-size:20px; border-radius:6px;
    pointer-events:none; animation:fadeOut 2s forwards; }
  @keyframes fadeOut { 0%{opacity:1;}100%{opacity:0;transform:translate(-50%,-80%);} }
</style>
</head>
<body>

<canvas id="renderCanvas"></canvas>
<div id="joystick-container"></div>
<div id="hud">
  <div id="healthBarContainer"><div id="healthBar"></div></div>
  <div id="keyIndicator"></div>
  <div class="action-btn" id="attack-btn">üó°Ô∏è</div>
  <div class="action-btn" id="magic-btn">ü™Ñ</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
// ---- Inicializaci√≥n Babylon ----
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);
scene.collisionsEnabled = true;
scene.gravity = new BABYLON.Vector3(0,-9.81,0);

const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0,1,-5), scene);
camera.attachControl(canvas,true);
camera.checkCollisions = camera.applyGravity = true;
camera.ellipsoid = new BABYLON.Vector3(1,1,1);
camera.maxStepHeight = 1;

new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

// ---- HUD y estado ----
let vida = 100, hasKey = false;
const healthBar = document.getElementById("healthBar");
const keyIndicator = document.getElementById("keyIndicator");

function updateHealth() {
  healthBar.style.width = vida + "%";
  if (vida <= 0) {
    alert("Has perdido!");
    location.reload();
  }
}

function showMsg(txt, color){
  const m = document.createElement("div");
  m.className="msg"; m.style.background = color; m.textContent = txt;
  document.body.appendChild(m);
  setTimeout(()=> m.remove(), 2000);
}

// ---- Controles ----
let joyX=0, joyY=0;
const joystick = nipplejs.create({
  zone: document.getElementById("joystick-container"),
  mode:"static", position:{ left:'75px', bottom:'75px' },
  size:120, color:'white'
});
joystick.on('move',(_,d)=>{ joyX=d.vector.x; joyY=d.vector.y; });
joystick.on('end',()=>{ joyX=joyY=0; });

function fireBullet(){
  const b = BABYLON.MeshBuilder.CreateSphere("",{diameter:0.4},scene);
  const mat = new BABYLON.StandardMaterial("",scene);
  mat.emissiveColor = new BABYLON.Color3(0,1,0); b.material=mat;
  b.position = camera.position.add(camera.getDirection(BABYLON.Axis.Z).scale(2));
  const dir = camera.getDirection(BABYLON.Axis.Z).scale(6);
  const obs = scene.onBeforeRenderObservable.add(()=>{
    b.position.addInPlace(dir);
    if (b.position.y < -10) {
      scene.onBeforeRenderObservable.remove(obs);
      b.dispose();
    }
  });
  setTimeout(()=>{
    scene.onBeforeRenderObservable.remove(obs);
    b.dispose();
  },2000);
}

document.getElementById("magic-btn").onclick = fireBullet;
document.getElementById("attack-btn").onclick = () => showMsg("üó°Ô∏è Ataque corto", "rgba(255,128,0,0.7)");

// ---- Entidades ----
const enemies = [], items = [];
let portalMesh = null;

BABYLON.SceneLoader.Append("", "mapa.glb", scene,()=>{
  scene.meshes.forEach(m=>m.checkCollisions=true);
  initEntities();
});

// Crear enemigos m√≥viles
function initEntities(){
  const ejemplos = [{x:2,z:2},{x:-3,z:1},{x:4,z:-2}];
  ejemplos.forEach(e=>createEnemy(e.x,e.z));
  createItem(1,0,'health',"https://i.ibb.co/Xr1rftKg/1b452991-913b-4dbe-8f25-43f7108d1d70.png");
  createItem(-1,3,'key',"https://i.ibb.co/HpKK2xwJ/1000012289-removebg-preview.png");
  portalMesh = BABYLON.MeshBuilder.CreateCylinder("portal",{height:0.1,diameter:1.5},scene);
  portalMesh.position = new BABYLON.Vector3(5,0.05,5);
  const pm = new BABYLON.StandardMaterial("",scene);
  pm.emissiveColor = new BABYLON.Color3(0.5,0,1); pm.alpha=0.7;
  portalMesh.material = pm;
}

// Enemigo
function createEnemy(x,z){
  const e = {mesh:null};
  BABYLON.SceneLoader.ImportMesh("", "", "bat.glb", scene, m=>{
    const m0 = m[0];
    m0.position=new BABYLON.Vector3(x,1.8,z);
    m0.scaling=new BABYLON.Vector3(0.07,0.07,0.07);
    m0.checkCollisions=true;
    e.mesh = m0;
  });
  enemies.push(e);
}

// √çtem
function createItem(x,z,type, img){
  const mat = new BABYLON.StandardMaterial("",scene);
  mat.diffuseTexture = new BABYLON.Texture(img,scene);
  const p = BABYLON.MeshBuilder.CreatePlane(type,{width:0.4,height:0.4},scene);
  p.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;
  p.position=new BABYLON.Vector3(x,0.5,z);
  p.material = mat;
  items.push({mesh:p,type});
}

// ---- Loop principal ----
engine.runRenderLoop(()=>{
  const f = camera.getDirection(BABYLON.Axis.Z),
        r = camera.getDirection(BABYLON.Axis.X);
  camera.cameraDirection = BABYLON.Vector3.Zero()
    .addInPlace(f.scale(joyY * 0.1))
    .addInPlace(r.scale(joyX * 0.1));

  enemies.forEach(e=>{
    if(!e.mesh) return;
    const d = camera.position.subtract(e.mesh.position).length();
    if(d<30 && d>1) {
      const m = camera.position.subtract(e.mesh.position).normalize().scale(0.06);
      e.mesh.moveWithCollisions(m);
    }
  });

  // Items
  items.forEach((it,i)=>{
    const d = BABYLON.Vector3.Distance(camera.position,it.mesh.position);
    if(d < 1){
      if(it.type === 'health'){
        vida = Math.min(vida + 25, 100);
        updateHealth();
        showMsg("+25 Salud", "#0f0");
      }
      if(it.type === 'key'){
        hasKey = true;
        keyIndicator.style.opacity = 1;
        showMsg("¬°Llave obtenida!", "#ff0");
        const pm2 = new BABYLON.StandardMaterial("",scene);
        pm2.emissiveColor = new BABYLON.Color3(0.8,0.2,1);
        pm2.alpha = 0.8;
        portalMesh.material = pm2;
        const ps = new BABYLON.ParticleSystem("",200,scene);
        ps.particleTexture = new BABYLON.Texture("https://i.ibb.co/whLynn2/px.png",scene);
        ps.emitter = portalMesh;
        ps.start();
      }
      it.mesh.dispose();
      items.splice(i,1);
    }
  });

  // Portal
  if(portalMesh){
    portalMesh.rotation.y += 0.01;
    const d = BABYLON.Vector3.Distance(camera.position, portalMesh.position);
    if(hasKey && d < 1){
      location.href = "nivel2.html";
    }
  }

  scene.render();
});

window.addEventListener("resize", ()=>engine.resize());
</script>
</body>
</html>
