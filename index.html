<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Juego con mapa.glb + enemigos/items/portal/llave</title>
<style>
  html, body { margin:0; width:100%; height:100%; overflow:hidden; background:#000; }
  #renderCanvas { width:100%; height:100%; display:block; }
  #joystick-container { position:absolute; bottom:30px; left:30px; width:150px; height:150px; z-index:10; }
  #hud { position:absolute; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:20; }
  #crosshair { position:absolute; width:3px; height:3px; background:red; border-radius:50%;
               top:50%; left:50%; margin:-1.5px 0 0 -1.5px; }
  .button { position:absolute; bottom:30px; width:60px; height:60px;
            background:rgba(255,255,255,0.2); border-radius:50%; color:white;
            font-size:24px; text-align:center; line-height:60px;
            user-select:none; pointer-events:auto; }
  #btnAttack { right:100px; }
  #btnBow { right:180px; }
  #hudOverlay { position:absolute; top:10px; left:10px; color:white; font-size:18px; }
  #healthBarContainer { width:200px; height:20px; background:#444; border:1px solid #fff; margin-top:4px; }
  #healthBar { height:100%; width:100%; background:#0f0; }
</style>
</head>
<body>

<canvas id="renderCanvas"></canvas>
<div id="joystick-container"></div>
<div id="hud">
  <div id="crosshair"></div>
  <div id="btnAttack" class="button">âš”</div>
  <div id="btnBow" class="button">ðŸŽ¯</div>
  <div id="hudOverlay">
    Vida:
    <div id="healthBarContainer"><div id="healthBar"></div></div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
// Setup Babylon
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);
scene.collisionsEnabled = true;
scene.gravity = new BABYLON.Vector3(0, -9.81, 0);

// Camera
const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0,1,-5), scene);
camera.attachControl(canvas, true);
camera.checkCollisions = true;
camera.applyGravity = true;
camera.ellipsoid = new BABYLON.Vector3(1,1,1);
camera.maxStepHeight = 1;

// Light
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

// HUD & Controls
let vidaJugador = 5;
const barraVida = document.getElementById("healthBar");
function actualizarVida(){
  barraVida.style.width = (vidaJugador * 20) + "%";
  if(vidaJugador <= 0) alert("Has perdido");
}
actualizarVida();

// Joystick
let joyX = 0, joyY = 0;
const joystick = nipplejs.create({
  zone: document.getElementById('joystick-container'),
  mode: 'static', position: {left:'75px', bottom:'75px'},
  size:120, color:'white'
});
joystick.on('move', (_, d) => { joyX = d.vector.x; joyY = d.vector.y; });
joystick.on('end', () => { joyX = 0; joyY = 0; });

// Bullets
function crearBala(origen, dir){
  const bala = BABYLON.MeshBuilder.CreateSphere("bala", {diameter:0.3}, scene);
  bala.position = origen.clone();
  const mat = new BABYLON.StandardMaterial("bMat", scene);
  mat.emissiveColor = new BABYLON.Color3(0,1,0);
  bala.material = mat;
  bala._dir = dir.normalize().scale(4);
  bala._obs = scene.onBeforeRenderObservable.add(() => {
    bala.position.addInPlace(bala._dir);
    if(bala.position.y < -10){
      scene.onBeforeRenderObservable.remove(bala._obs);
      bala.dispose();
    }
  });
  setTimeout(() => {
    scene.onBeforeRenderObservable.remove(bala._obs);
    bala.dispose();
  }, 2000);
}
document.getElementById("btnBow").onclick = () => crearBala(camera.position.add(camera.getDirection(BABYLON.Axis.Z).scale(2)), camera.getDirection(BABYLON.Axis.Z));
document.getElementById("btnAttack").onclick = () => {
  const atk = BABYLON.MeshBuilder.CreateBox("atk", {size:1}, scene);
  atk.position = camera.position.add(camera.getDirection(BABYLON.Axis.Z).scale(2));
  setTimeout(()=> atk.dispose(), 200);
};

// Load map
BABYLON.SceneLoader.Append("", "mapa.glb", scene, () => {
  scene.meshes.forEach(m => { m.checkCollisions = true; });
  camera.position = new BABYLON.Vector3(0,1,-5);
  initEntities();
});

// Entity storage
const enemies = [], items = [], portal = {mesh:null, active:false}, key = {picked:false};

// Populate enemies/items
function initEntities(){
  // Example enemy positions â€“ ajusta a tus datos.
  const dummy = [ {x:2,z:2}, {x:-3,z:1} ];
  dummy.forEach(e => enemies.push(createEnemy(e.x,e.z)));
  
  // Items
  const texHealth = new BABYLON.StandardMaterial("",scene);
  texHealth.diffuseTexture = new BABYLON.Texture("https://i.ibb.co/Xr1rftKg/1b452991-913b-4dbe-8f25-43f7108d1d70.png", scene);
  createItem(1,0,"health", texHealth);
  
  // Key
  const texKey = new BABYLON.StandardMaterial("",scene);
  texKey.diffuseTexture = new BABYLON.Texture("https://i.ibb.co/HpKK2xwJ/1000012289-removebg-preview.png", scene);
  createItem(-1,3,"key", texKey);

  // Portal
  portal.mesh = BABYLON.MeshBuilder.CreateCylinder("portal",{height:0.1,diameter:1.5},scene);
  portal.mesh.position=new BABYLON.Vector3(4,0.05,4);
  const pMat = new BABYLON.StandardMaterial("pMat",scene);
  pMat.emissiveColor=new BABYLON.Color3(0.5,0,1); pMat.alpha=0.7;
  portal.mesh.material=pMat;
}

// Enemy creation
function createEnemy(x,z){
  const container = {};
  BABYLON.SceneLoader.ImportMesh("", "", "bat.glb", scene, (meshes) => {
    const mesh = meshes[0];
    mesh.position=new BABYLON.Vector3(x,1.8,z);
    mesh.scaling=new BABYLON.Vector3(0.07,0.07,0.07);
    mesh.checkCollisions=true;
    container.mesh = mesh;
  });
  container.health = 50;
  return container;
}

// Item creation
function createItem(x,z,type, mat){
  const mesh = BABYLON.MeshBuilder.CreatePlane(type,{width:0.3,height:0.3},scene);
  mesh.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;
  mesh.position = new BABYLON.Vector3(x,0.5,z);
  mesh.material = mat;
  items.push({mesh,type,x,z});
}

// Game loop
engine.runRenderLoop(() => {
  // Move camera
  const f = camera.getDirection(BABYLON.Axis.Z);
  const r = camera.getDirection(BABYLON.Axis.X);
  camera.cameraDirection = BABYLON.Vector3.Zero()
    .addInPlace(f.scale(joyY * 0.1))
    .addInPlace(r.scale(joyX * 0.1));
  
  // Update enemies
  enemies.forEach(e => {
    if(e.mesh){
      const dir = camera.position.subtract(e.mesh.position);
      const dist = dir.length();
      if(dist<30 && dist>1){
        const move = dir.normalize().scale(0.06);
        e.mesh.moveWithCollisions(move);
      }
      if(dist<=1){
        // damage
        vidaJugador -= 0.5;
        actualizarVida();
      }
    }
  });
  
  // Check items
  items.forEach((it,i) => {
    const d = BABYLON.Vector3.Distance(camera.position, it.mesh.position);
    if(d<1){
      if(it.type==="health") vidaJugador = Math.min(vidaJugador+25,5);
      if(it.type==="key") portal.active=true;
      actualizarVida();
      it.mesh.dispose();
      items.splice(i,1);
    }
  });
  
  // Portal
  if(portal.mesh){
    portal.mesh.rotation.y += 0.01;
    if(portal.active && BABYLON.Vector3.Distance(camera.position, portal.mesh.position)<1){
      alert("Â¡Nivel completado!");
      portal.mesh.dispose();
    }
  }

  scene.render();
});
window.addEventListener("resize", ()=>engine.resize());
</script>
</body>
</html>
