<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Juego Interactivo</title>
  <style>
    html, body { margin: 0; overflow: hidden; background: #000; }
    #renderCanvas { width: 100%; height: 100%; display: block; }
    #pickupMsg {
      position: absolute; top: 50%; left: 50%;
      transform: translate(-50%, -50%);
      color: #0ff; font-size: 24px;
      font-weight: bold; opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
    }
  </style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="pickupMsg"></div>

<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);
scene.gravity = new BABYLON.Vector3(0, -9.8, 0);
scene.collisionsEnabled = true;

// Cámara
const camera = new BABYLON.UniversalCamera("camera", new BABYLON.Vector3(0, 2, -10), scene);
camera.attachControl(canvas, true);
camera.applyGravity = true;
camera.checkCollisions = true;
camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);

// Luz
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

// Variables
let hasKey = false;
let portal;

// Mensaje en pantalla
const msg = document.getElementById("pickupMsg");
function showMsg(text) {
  msg.textContent = text;
  msg.style.opacity = 1;
  setTimeout(() => msg.style.opacity = 0, 1500);
}

// Mapa (si tienes uno)
BABYLON.SceneLoader.Append("", "mapa.glb", scene, () => {
  scene.meshes.forEach(mesh => mesh.checkCollisions = true);
  setupGame();
});

function setupGame() {
  // Crear llave
  const key = BABYLON.MeshBuilder.CreateBox("key", { size: 0.5 }, scene);
  key.position = new BABYLON.Vector3(0, 1, 5);
  key.material = new BABYLON.StandardMaterial("matKey", scene);
  key.material.diffuseColor = new BABYLON.Color3.Yellow();

  key.actionManager = new BABYLON.ActionManager(scene);
  key.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
    { trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, parameter: camera },
    () => {
      hasKey = true;
      showMsg("¡Llave recogida!");
      key.dispose();
      activatePortal();
    }
  ));

  // Crear poción
  const potion = BABYLON.MeshBuilder.CreateSphere("potion", { diameter: 0.5 }, scene);
  potion.position = new BABYLON.Vector3(2, 1, 4);
  potion.material = new BABYLON.StandardMaterial("matPotion", scene);
  potion.material.diffuseColor = new BABYLON.Color3.Green();

  potion.actionManager = new BABYLON.ActionManager(scene);
  potion.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
    { trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, parameter: camera },
    () => {
      showMsg("+25 Salud");
      potion.dispose();
    }
  ));

  // Crear portal
  portal = BABYLON.MeshBuilder.CreateTorus("portal", { diameter: 2, thickness: 0.2 }, scene);
  portal.position = new BABYLON.Vector3(4, 1, 4);
  portal.rotation.x = Math.PI / 2;
  portal.material = new BABYLON.StandardMaterial("matPortal", scene);
  portal.material.emissiveColor = new BABYLON.Color3(0.2, 0, 0.3);
  portal.material.alpha = 0.5;

  portal.actionManager = new BABYLON.ActionManager(scene);
  portal.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
    { trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, parameter: camera },
    () => {
      if (hasKey) {
        showMsg("¡Nivel completado!");
        setTimeout(() => {
          window.location.href = "nivel2.html";
        }, 1500);
      } else {
        showMsg("Necesitas la llave");
      }
    }
  ));
}

function activatePortal() {
  if (portal) {
    portal.material.emissiveColor = new BABYLON.Color3(0.8, 0.2, 1);
    portal.material.alpha = 0.9;
  }
}

// Movimiento básico con teclado
scene.onBeforeRenderObservable.add(() => {
  const speed = 0.1;
  if (scene.activeCamera) {
    const inputMap = scene.activeCamera._inputs;
    if (inputMap) {
      // Movimiento opcional si quieres control manual
    }
  }
});

// Animación del portal
scene.registerBeforeRender(() => {
  if (portal) portal.rotation.z += 0.01;
});

engine.runRenderLoop(() => {
  scene.render();
});

window.addEventListener("resize", () => engine.resize());
</script>
</body>
</html>
