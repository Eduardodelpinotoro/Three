<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Juego nivel 1</title>
<style>
  html,body{margin:0;overflow:hidden;background:#000}
  #renderCanvas{width:100%;height:100%}
  #joystick-container{position:absolute;bottom:30px;left:30px;width:150px;height:150px;z-index:10}
  .button{position:absolute;bottom:30px;width:60px;height:60px;background:rgba(255,255,255,0.2);border-radius:50%;pointer-events:auto;}
  #btnAttack{right:100px} #btnMagic{right:180px}
  #healthBarContainer{position:absolute;top:10px;left:10px;width:200px;height:20px;background:#444;border:1px solid #fff}
  #healthBar{height:100%;width:50%;background:#0f0;transition:width .3s}
  #pickupMsg{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#0ff;font-weight:bold;font-size:22px;opacity:0;pointer-events:none;transition:opacity .3s;}
</style>
</head>
<body>
<canvas id="renderCanvas"></canvas>
<div id="joystick-container"></div>
<div id="healthBarContainer"><div id="healthBar"></div></div>
<div id="pickupMsg"></div>
<div class="button" id="btnAttack"></div>
<div class="button" id="btnMagic"></div>

<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas,true);
const scene = new BABYLON.Scene(engine);
scene.gravity = new BABYLON.Vector3(0,-9.81,0);
scene.collisionsEnabled = true;

const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(1,1,-5), scene);
camera.attachControl(canvas,true);
camera.checkCollisions = true;
camera.applyGravity = true;
camera.ellipsoid = new BABYLON.Vector3(0.5,1,0.5);

new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

let vidaJugador = 50;
const healthBar = document.getElementById("healthBar");
const pickupMsg = document.getElementById("pickupMsg");

function updateHealthBar(){
  healthBar.style.width = Math.min(vidaJugador,100) + "%";
  if(vidaJugador <= 0){ alert("Has perdido"); location.reload(); }
}
updateHealthBar();

function showPickup(text){
  pickupMsg.textContent = text;
  pickupMsg.style.opacity = 1;
  setTimeout(()=> pickupMsg.style.opacity = 0, 1000);
}

let joyX=0, joyY=0;
const joystick = nipplejs.create({
  zone: document.getElementById("joystick-container"),
  mode: "static", 
  position: {left:"75px", bottom:"75px"},
  size: 120, 
  color: "white"
});
joystick.on("move", (_,d)=>{ joyX=d.vector.x; joyY=d.vector.y; });
joystick.on("end", ()=>{ joyX=0; joyY=0; });

const config = { attackRange:5, playerAttackDamage:20 };

const enemies = [], items = [], itemMeshes = [];
let portalMesh=null, portalActive=false, hasKey=false;

// Carga del mapa
BABYLON.SceneLoader.Append("", "mapa.glb", scene, ()=>{
  scene.meshes.forEach(m=>{
    m.checkCollisions = true;
    if(m.name.includes("ground")) m.receiveShadows = true;
  });
  initEntities();
});

function initEntities(){
  // Enemigos
  [{x:2,z:2},{x:-3,z:1},{x:5,z:-4}].forEach(e=>enemies.push(createEnemy(e.x,e.z)));
  
  // Item de salud
  const texH = new BABYLON.StandardMaterial("healthTex",scene);
  texH.diffuseTexture = new BABYLON.Texture("https://i.ibb.co/Xr1rftKg/1b452991-913b-4dbe-8f25-43f7108d1d70.png",scene);
  createItem(1,0,"health",texH);
  
  // Llave
  const texK = new BABYLON.StandardMaterial("keyTex",scene);
  texK.diffuseTexture = new BABYLON.Texture("https://i.ibb.co/HpKK2xwJ/1000012289-removebg-preview.png",scene);
  createItem(-1,3,"key",texK);
  
  // Portal
  portalMesh = BABYLON.MeshBuilder.CreateCylinder("portal",{height:0.1,diameter:1.5},scene);
  portalMesh.position = new BABYLON.Vector3(4,0.05,4);
  const pMat = new BABYLON.StandardMaterial("portalMat",scene);
  pMat.emissiveColor = new BABYLON.Color3(0.5,0,1);
  pMat.alpha = 0.7;
  portalMesh.material = pMat;
}

function createEnemy(x,z){
  const enemy = {mesh:null,health:50};
  BABYLON.SceneLoader.ImportMeshAsync(null,"","bat.glb",scene).then(r=>{
    const m = r.meshes[0];
    m.position = new BABYLON.Vector3(x,0.5,z);
    m.scaling = new BABYLON.Vector3(0.1,0.1,0.1);
    m.checkCollisions = true;
    enemy.mesh = m;
  });
  return enemy;
}

function createItem(x,z,type,mat){
  const m = BABYLON.MeshBuilder.CreatePlane(type,{width:0.5,height:0.5},scene);
  m.billboardMode = BABYLON.Mesh.BILLBOARDMODE_ALL;
  m.position = new BABYLON.Vector3(x,0.5,z);
  m.material = mat;
  const lt = new BABYLON.PointLight("",m.position,scene);
  lt.intensity = 0.5;
  items.push({x,z,type});
  itemMeshes.push({mesh:m,light:lt,data:{x,z,type}});
}

function checkItemCollisions(){
  const playerPos = camera.position;
  
  for(let i = itemMeshes.length-1; i >= 0; i--){
    const obj = itemMeshes[i];
    const itemPos = obj.mesh.position;
    const dist = BABYLON.Vector3.Distance(playerPos, itemPos);
    
    if(dist < 1.5){
      collectItem(obj.data);
      items.splice(items.findIndex(it=> 
        it.x === obj.data.x && it.z === obj.data.z && it.type === obj.data.type),1);
      obj.mesh.dispose();
      obj.light.dispose();
      itemMeshes.splice(i,1);
    }
  }
}

function collectItem(item){
  if(item.type === "health"){
    vidaJugador = Math.min(vidaJugador+25,100);
    updateHealthBar();
    showPickup("+25 Salud");
  }else if(item.type === "key"){
    hasKey = true;
    portalActive = true;
    portalMesh.material.emissiveColor = new BABYLON.Color3(0.8,0.2,1);
    showPickup("Llave obtenida");
  }
}

function playerAttack(){
  const flash = new BABYLON.PointLight("attackFlash",camera.position,scene);
  flash.diffuse = new BABYLON.Color3(1,0.5,0);
  flash.range = config.attackRange;
  setTimeout(()=>flash.dispose(),100);

  enemies.forEach(enemy=>{
    if(enemy.mesh && enemy.health > 0){
      const dist = BABYLON.Vector3.Distance(camera.position,enemy.mesh.position);
      if(dist <= config.attackRange){
        enemy.health -= config.playerAttackDamage;
        if(enemy.health <= 0){
          enemy.mesh.dispose();
          enemy.mesh = null;
        }
      }
    }
  });
}

function castMagic(){
  const magicFlash = new BABYLON.HemisphericLight("magicFlash",camera.position,scene);
  magicFlash.diffuse = new BABYLON.Color3(0.2,0.4,1);
  magicFlash.groundColor = new BABYLON.Color3(0.1,0.2,0.5);
  setTimeout(()=>magicFlash.dispose(),200);

  enemies.forEach(e=>{
    if(e.mesh){
      const dist = BABYLON.Vector3.Distance(camera.position,e.mesh.position);
      if(dist <= config.attackRange*1.5){
        e.health -= config.playerAttackDamage;
        if(e.health <= 0) e.mesh.dispose();
      }
    }
  });
}

document.getElementById("btnAttack").onclick = playerAttack;
document.getElementById("btnMagic").onclick = castMagic;

engine.runRenderLoop(()=>{
  // Movimiento
  const forward = camera.getDirection(BABYLON.Axis.Z);
  const right = camera.getDirection(BABYLON.Axis.X);
  const movement = forward.scale(joyY*0.1).add(right.scale(joyX*0.1));
  camera.position.addInPlace(movement);
  
  // Enemigos
  enemies.forEach(e=>{
    if(e.mesh && e.health > 0){
      const dir = camera.position.subtract(e.mesh.position).normalize();
      e.mesh.moveWithCollisions(dir.scale(0.03));
    }
  });
  
  // Items
  checkItemCollisions();
  
  // Portal
  if(portalMesh && portalActive && hasKey){
    portalMesh.rotation.y += 0.01;
    const dist = BABYLON.Vector3.Distance(camera.position,portalMesh.position);
    if(dist < 1.5){
      showPickup("Entrando al portal...");
      setTimeout(()=>{
        window.location.href = "nivel2.html";
      },1000);
    }
  }
  
  scene.render();
});

window.addEventListener("resize",()=>engine.resize());
</script>
</body>
</html>
