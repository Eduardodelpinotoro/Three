<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<title>Juego con mapa.glb y joystick nipplejs</title>
<style>
  html, body { margin:0; width:100%; height:100%; overflow:hidden; background:#000; }
  #renderCanvas { width:100%; height:100%; display:block; }
  #joystick-container { position:absolute; bottom:30px; left:30px; width:150px; height:150px; z-index:10; }
  #hud { position:absolute; top:0; left:0; right:0; bottom:0; pointer-events:none; z-index:20; }
  #crosshair { position:absolute; width:3px; height:3px; background:red; border-radius:50%;
               top:50%; left:50%; margin:-1.5px 0 0 -1.5px; }
  .button { position:absolute; bottom:30px; width:60px; height:60px;
            background:rgba(255,255,255,0.2); border-radius:50%; color:white;
            font-size:24px; text-align:center; line-height:60px;
            user-select:none; pointer-events:auto; }
  #btnAttack { right:100px; }
  #btnBow { right:180px; }
  #hudOverlay { position:absolute; top:10px; left:10px; color:white; font-size:18px; }
  #healthBarContainer { width:200px; height:20px; background:#444; border:1px solid #fff; margin-top:4px; }
  #healthBar { height:100%; width:100%; background:#0f0; transition: width 0.3s ease; }
</style>
</head>
<body>

<canvas id="renderCanvas"></canvas>

<!-- Contenedor para joystick -->
<div id="joystick-container"></div>

<div id="hud">
  <div id="crosshair"></div>
  <div id="btnAttack" class="button">‚öî</div>
  <div id="btnBow" class="button">üéØ</div>
  <div id="hudOverlay">
    Vida:
    <div id="healthBarContainer"><div id="healthBar"></div></div>
  </div>
</div>

<!-- Librer√≠as -->
<script src="https://cdn.jsdelivr.net/npm/nipplejs@0.9.0/dist/nipplejs.min.js"></script>
<script src="https://cdn.babylonjs.com/babylon.js"></script>
<script src="https://cdn.babylonjs.com/loaders/babylon.glTF2FileLoader.min.js"></script>

<script>
const canvas = document.getElementById("renderCanvas");
const engine = new BABYLON.Engine(canvas, true);
const scene = new BABYLON.Scene(engine);
scene.collisionsEnabled = true;
scene.gravity = new BABYLON.Vector3(0, -9.81, 0);

// C√°mara con colisiones y gravedad
const camera = new BABYLON.FreeCamera("cam", new BABYLON.Vector3(0,5,-10), scene);
camera.attachControl(canvas, true);
camera.checkCollisions = true;
camera.applyGravity = true;
camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);
camera.maxStepHeight = 1; // Altura m√°xima que puede subir (escal√≥n)

// Luz
new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,1,0), scene);

// Variables para joystick
let joyX = 0, joyY = 0;

// Crear joystick con nipplejs
const joystickContainer = document.getElementById('joystick-container');
const joystick = nipplejs.create({
  zone: joystickContainer,
  mode: 'static',
  position: { left: '75px', bottom: '75px' },
  color: 'white',
  size: 120,
});

joystick.on('move', function(evt, data) {
  if (data && data.vector) {
    joyX = data.vector.x;
    joyY = data.vector.y;
  }
});

joystick.on('end', function() {
  joyX = 0;
  joyY = 0;
});

// Vida jugador
let vidaJugador = 5;
const barraVida = document.getElementById("healthBar");
function actualizarVida(){
  barraVida.style.width = (vidaJugador * 20) + "%";
  if (vidaJugador <= 0) {
    alert("Has perdido");
    // Opcional: reiniciar juego o bloquear controles
  }
}
actualizarVida();

// Array de enemigos
const enemies = [];

// Funci√≥n para crear enemigo
function crearEnemigo(pos) {
  const enemigo = BABYLON.MeshBuilder.CreateBox("enemy", {size: 2}, scene);
  enemigo.position = pos.clone();
  enemigo.checkCollisions = true;
  const mat = new BABYLON.StandardMaterial("enemyMat", scene);
  mat.diffuseColor = BABYLON.Color3.Red();
  enemigo.material = mat;
  return {
    mesh: enemigo,
    vida: 100,
    lastDamageToPlayerTime: 0,
  };
}

// Crear algunos enemigos para ejemplo
enemies.push(crearEnemigo(new BABYLON.Vector3(10, 1, 10)));
enemies.push(crearEnemigo(new BABYLON.Vector3(-10, 1, 15)));
enemies.push(crearEnemigo(new BABYLON.Vector3(8, 1, -8)));

// Mover enemigos y aplicar da√±o jugador
scene.onBeforeRenderObservable.add(() => {
  enemies.forEach(e => {
    if (!e.mesh || e.mesh.isDisposed()) return;

    const dir = camera.position.subtract(e.mesh.position);
    const dist = dir.length();

    // Mover hacia jugador si est√° a distancia entre 1 y 30
    if (dist < 30 && dist > 1) {
      const move = dir.normalize().scale(0.06);
      e.mesh.moveWithCollisions(move);
    }

    // Si est√° a menos de 1 unidad, hacer da√±o con cooldown 1 seg
    if (dist <= 1) {
      const now = Date.now();
      if (now - e.lastDamageToPlayerTime > 1000) {
        vidaJugador -= 1;
        actualizarVida();
        e.lastDamageToPlayerTime = now;
      }
    }
  });
});

// Detectar colisiones bala-enemigo
function detectarColisiones() {
  scene.meshes.forEach(mesh => {
    if (mesh.name === "bala") {
      enemies.forEach(e => {
        if (e.mesh && !e.mesh.isDisposed() && e.mesh.intersectsMesh(mesh, false)) {
          e.vida -= 20; // Quitar 20 vida por bala
          mesh.dispose();

          if (e.vida <= 0) {
            e.mesh.dispose();
          } else {
            // Parpadeo color para da√±o
            e.mesh.material.diffuseColor = new BABYLON.Color3(1, 0.5, 0.5);
            setTimeout(() => {
              if (e.mesh && !e.mesh.isDisposed())
                e.mesh.material.diffuseColor = BABYLON.Color3.Red();
            }, 200);
          }
        }
      });
    }
  });
}

// Crear bala disparada
function crearBala(origen, dir) {
  const bala = BABYLON.MeshBuilder.CreateSphere("bala", { diameter: 0.3 }, scene);
  bala.position = origen.clone();
  const mat = new BABYLON.StandardMaterial("bMat", scene);
  mat.emissiveColor = new BABYLON.Color3(0, 1, 0);
  bala.material = mat;
  bala._dir = dir.normalize().scale(4);

  bala._obs = scene.onBeforeRenderObservable.add(() => {
    bala.position.addInPlace(bala._dir);
    detectarColisiones();
    if (bala.position.y < -10) {
      scene.onBeforeRenderObservable.remove(bala._obs);
      bala.dispose();
    }
  });

  setTimeout(() => {
    if (bala && !bala.isDisposed()) {
      scene.onBeforeRenderObservable.remove(bala._obs);
      bala.dispose();
    }
  }, 2000);
}

// Botones disparo
document.getElementById("btnBow").addEventListener("click", () => {
  crearBala(camera.position.add(camera.getDirection(BABYLON.Axis.Z).scale(2)),
            camera.getDirection(BABYLON.Axis.Z));
});
document.getElementById("btnAttack").addEventListener("click", () => {
  // Ataque cuerpo a cuerpo - aqu√≠ puedes a√±adir l√≥gica extra si quieres
  const atk = BABYLON.MeshBuilder.CreateBox("atk", { size: 1 }, scene);
  atk.position = camera.position.add(camera.getDirection(BABYLON.Axis.Z).scale(2));
  setTimeout(() => atk.dispose(), 200);
});

// Cargar mapa glb
BABYLON.SceneLoader.Append("", "mapa.glb", scene, function() {
  scene.meshes.forEach(m => {
    m.checkCollisions = true;
  });
});

// Control de movimiento jugador
scene.onBeforeRenderObservable.add(() => {
  const forward = camera.getDirection(BABYLON.Axis.Z);
  const right = camera.getDirection(BABYLON.Axis.X);

  const moveVector = forward.scale(joyY * 0.2).add(right.scale(joyX * 0.2));
  camera.moveWithCollisions(moveVector);
});

// Loop render
engine.runRenderLoop(() => {
  scene.render();
});

// Redimensionar
window.addEventListener("resize", () => {
  engine.resize();
});
</script>

</body>
</html>
